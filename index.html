<!doctype html>
<html>
<head>
<title>Hard Vacuum: Recon</title>
<style type="text/css">
#viewport {
  position: relative;
  border: 1px solid #000;
}
#background {
  background-image: url(img/snow.png);
  position: relative;
  display: block;
  overflow: hidden;
}
#copter {
  display: block;
  position: absolute;
  bottom: 5px;
  left: 90px;
}
.snow {
  background-image: url(img/snow.png);
}
.icicle1 {
  background-image: url(img/icicle1.png);
  position: absolute;
  top: 0;
  left: 0;
  display: block;
  height: 20px;
  width: 20px;
}
.icicle2 {
  background-image: url(img/icicle2.png);
  position: absolute;
  top: 0;
  left: 0;
  display: block;
  height: 40px;
  width: 20px;
}
.icicle3 {
  background-image: url(img/icicle3.png);
  position: absolute;
  top: 0;
  left: 0;
  display: block;
  height: 60px;
  width: 40px;
}
.row {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
}
.tile {
  display: inline-block;
  height: 20px;
  width: 20px;
}
</style>
</head>
<body>
<div id="viewport">
<div id="background">
</div>
<img id="copter" src="img/copter.png"/>
</div>
<div id="fps"></div>
<script type="text/javascript">
(function () {
  var lastTime = 0;
  var vendor = ["ms", "mos", "webkit", "o"];
  var i = 0;
  while (i < vendor.length && !window.requestAnimationFrame) {
    window.requestAnimationFrame = window[vendor[i]+"RequestAnimationFrame"];
    window.cancelAnimationFrame = window[vendor[i]+"CancelAnimationFrame"] || window[vendor[i]+"RequestCancelAnimationFrame"];
    i += 1;
  }

  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function (callback, element) {
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
      var timerId = setTimeout(function () {
        callback(currTime + timeToCall);
      }, timeToCall);
      lastTime = currTime + timeToCall;
      return timerId;
    };
  }

  if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function (id) {
      clearTimeout(id);
    };
  }
}());

var $ = function (selector) {
  if (selector.indexOf("#") === 0) {
    return document.getElementById(selector.slice(1));
  }
  if (selector.indexOf(".") === 0) {
    return document.getElementByClassName(selector.slice(1));
  }
  return null;
};

var Timer = {};
Timer.tick = function (now) {
  Timer.delta = (now - (Timer.then || now)) / 1000;
  Timer.then = now;
};

var canvasHeight = 320;
var canvasWidth = 240;
var tileHeight = 20;
var tileWidth = 20;
var numCols = canvasWidth / tileWidth;
var numRows = (canvasHeight / tileHeight) + 1;
var copterSpeed = 10;

var hasClass = function (element, klass) {
  return element.classList.contains(klass);
};

var isIcicle = function (element) {
  return hasClass(element, "icicle1") || hasClass(element, "icicle2") || hasClass(element, "icicle3");
};

var isRow = function (element) {
  return hasClass(element, "row");
};

var lastIcicle = null;
var addIcicle = function (element) {
  var offsetTop = parseInt(element.style.top);
  var index = Math.floor(Math.random() * numCols);
  var icicle = document.createElement("div");
  var types = [
    "icicle1", "icicle1", "icicle1", "icicle1",
    "icicle2", "icicle2",
    "icicle3"
  ];
  var klass = types[Math.floor(Math.random() * types.length)];
  icicle.setAttribute("class", klass);
  if (klass === "icicle3") {
    offsetTop -= 40;
  }
  if (klass === "icicle2") {
    offsetTop -= 20;
  }
  if (klass === "icicle1") {
    offsetTop -= 0;
  }
  icicle.style.top = offsetTop+"px";
  icicle.style.left = (index * tileWidth)+"px";
  lastIcicle = $("#background").insertBefore(icicle, lastIcicle);
};

var updateIcicle = function (element) {
  if (isIcicle(element)) {
    $("#background").removeChild(element);
    return;
  }
  if (isRow(element)) {
    addIcicle(element);
    return;
  }
};

var setup = function () {
  var x = 0;
  var y = 0;
  var viewport = $("#viewport");
  viewport.style.height = canvasHeight+"px";
  viewport.style.width = canvasWidth+"px";
  var background = $("#background");
  background.style.width = viewport.style.width;
  background.style.height = viewport.style.height;
  var row = null;
  var tile = null;
  for (y = 0; y < numRows; y += 1) {
    row = document.createElement("div");
    row.setAttribute("class", "row");
    row.style.top = ((y * tileHeight) - tileHeight)+"px";
    row.style.left = "0px";
    for (x = 0; x < numCols; x += 1) {
      tile = document.createElement("span");
      tile.setAttribute("class", "snow tile");
      row.appendChild(tile);
    }
    background.appendChild(row);
  }
};

var movey = function (element, delta, max) {
  if (!element || !element.style) {
    return;
  }
  if (element.style.top === "") {
    element.style.top = "0px";
  }
  var offset = parseInt(element.style.top);
  var warp = false;
  delta = (delta + 0.5) | 0;
  if (offset + delta >= max) {
    offset = -tileHeight;
    warp = true;
  }
  offset += delta;
  element.style.top = offset+"px";
  return warp;
};

var lastFPS = 0;
var updateFPS = function () {
  var now = Date.now();
  if (now - lastFPS > 1000) {
    lastFPS = now;
    $("#fps").innerHTML = "FPS: "+Math.floor(1 / Timer.delta);
  }
};

var render = function (time) {
  requestAnimationFrame(render);
  Timer.tick(time);
  var rows = $("#background").childNodes;
  var y = 0;
  var offset = copterSpeed * Timer.delta;
  var warped = false;
  for (y = 0; y < rows.length; y += 1) {
    warped = movey(rows[y], offset, canvasHeight);
    if (warped) {
      updateIcicle(rows[y]);
    }
  }
  updateFPS();
};

setup();
requestAnimationFrame(render);
</script>
</body>
</html>
